## 项目目标
- **构建一个基于 Vue 3 + TypeScript + PDF.js + Stirling PDF 的在线 PDF 编辑器**，支持在线预览、注释（高亮/文本/形状/下划线）、页面操作（缩放/旋转/缩略图/跳转）、搜索、导出（客户端或通过 Stirling PDF 服务端处理）。

## 分阶段任务

### 第 0 阶段：准备与方案敲定
- [ ] 明确 Stirling PDF 的可用 API（是否有 REST/HTTP 接口可供前端调用：旋转/合并/拆分/水印/签章/压缩/OCR/转换/表单扁平化等）。
- [ ] 设计整体架构：前端（Vue3+TS+PDF.js）+ 可选后端（Stirling PDF 自托管服务）+ 代理层（本地 `vite` 代理或 Nginx）。
- [ ] 确定编辑实现策略：
  - [ ] 渲染和注释层：PDF.js 渲染画布 + 前端矢量/DOM 覆盖层。
  - [ ] 导出策略 A（客户端）：将覆盖层扁平化合成到 PDF（考虑 `pdf-lib`）；
  - [ ] 导出策略 B（服务端）：将编辑指令提交给 Stirling PDF，由其生成新 PDF。
- [ ] 明确跨域、安全、文件体积与性能方案。

### 第 1 阶段：项目初始化
- [ ] 使用 Vite 初始化 Vue 3 + TypeScript 工程。
- [ ] 配置别名、环境变量（`VITE_STIRLING_BASE_URL`）。
- [ ] 安装依赖：`pdfjs-dist`、类型声明、工具库（可选：`pdf-lib`）。
- [ ] 基础目录结构与路由：`/viewer` 主页面。

### 第 2 阶段：PDF 基础查看器
- [x] 通过 PDF.js 加载与渲染多页 PDF（支持本地上传/URL 加载）。
- [x] 工具栏：放大/缩小、页面跳转、旋转、适配宽度/页面。
- [x] 侧栏缩略图与大纲/书签（若有）。
- [x] 文本搜索（页级匹配跳转；后续增强为高亮）。

### 第 3 阶段：注释与编辑层
- [x] 交互图层（Overlay）：
  - [x] 文本框（字体、大小、颜色，点击放置；双击可编辑；后续增强：缩放旋转）。
  - [x] 高亮矩形（颜色与透明度）。
  - [x] 基础形状：矩形（后续再加椭圆/箭头）。
  - [x] 撤销/重做（基于注释快照）。
  - [x] 选择模式拖动注释（仅重绘覆盖层，避免与 PDF 并发渲染）。
  - [x] 文本编辑器：透明背景、单行高度、自适应（auto-resize）、不可手动调节。
- [x] 持久化（本地存储）：按文档键保存/恢复注释，编辑 300ms 防抖自动保存。

#### 编辑器功能补充（新需求）
基本编辑功能
- [x] Pointer（指针）：文本选择（textSelect）与编辑选择（select）拆分：
  - [x] 文本选择：原生文本选中/复制（自定义文本层，避免遮挡；选择时禁用框选）。
  - [x] 编辑选择：选择/多选/拖动已有注释；禁用绘制；防止文本层拦截。
- [x] Text（文本）：添加/编辑与简单格式（颜色、字号）。
- [ ] Replace Text（替换文本）：对现有 PDF 文本做替换（基于文本提取与坐标回填）。-先不做
- [x] Highlight（高亮）：文本/区域高亮（预览与导出透明度一致）。
  - [x] Add Image（添加图片）：插入/拖动/缩放/旋转图片，导出扁平化（基础能力已实现）。
- [x] Eraser（橡皮擦）：可调半径；拖动命中即删（矩形/高亮/图片/椭圆/多边形/路径/文本）。
- [x] Shapes（形状）：新增椭圆、线段、箭头（含箭头头部预览/渲染/导出）、多边形。
- [x] Draw（绘图）：自由画笔（颜色/粗细），SVG 预览，导出为折线。

高级编辑与格式化
- [x] Underline（下划线）：基于精确选区的文本下划线，支持部分文本选择和跨行选择。
- [ ] Strikeout（删除线）：文本删除线样式/导出。
- [x] Move Up/Move Down（页面上移/下移）：侧栏缩略图“上移/下移”按钮，视觉顺序更新并持久化；翻页按新顺序。
- [ ] Delete（删除）：删除选定元素（快捷键 Delete/Backspace）。
- [ ] Highlight（高光）
- [ ] Redact（遮挡）

已实现能力的优化清单
- [ ] 选择框描边与键盘微调（箭头键移动，Shift 加速，网格吸附）。
- [ ] 大文档性能：长页/多注释虚拟化渲染与分块重绘。
- [ ] 文本替换/搜索联动：搜索结果一键高亮/替换。
- [ ] 导出进度与大文件分片（客户端/服务端）。

### 第 4 阶段：导出与保存
- [x] 导出（客户端方案）：
  - [x] 使用 `pdf-lib` 将注释扁平化到新 PDF（文本/高亮矩形/矩形）。
- [x] 导出（服务端方案）：
  - [x] 自建后端 `/api/annotate/flatten`：接收原 PDF 或 URL + 注释 JSON，服务端用 `pdf-lib` 扁平化导出。
  - [x] 前端按钮“服务端导出”与代理 `/api` 打通（VITE_API_BASE_URL 缺省回落到 http://localhost:3000）。
  - [ ] 与 Stirling PDF 对接（合并/拆分/压缩/OCR 等通用能力）。

### 第 5 阶段：Stirling PDF 能力透出
- [ ] 文件级操作：合并、拆分、旋转、压缩、加密/解密、提取页面、OCR、格式转换（PDF<->图片/Office）。
- [ ] 在 UI 中集成为工具面板，调用 Stirling PDF API 完成任务。
- [ ] 队列/任务状态与错误提示。

### 第 6 阶段：文件与权限
- [ ] 限制文件大小与格式检查。
- [ ] 跨域与认证（若 Stirling PDF 受保护，配置 Token/Basic Auth）。
- [ ] 断点续传（可选）。

### 第 7 阶段：打包与部署
- [ ] 本地开发代理至 Stirling PDF。
- [ ] 生产打包与静态资源优化。
- [ ] Docker 化前端（可选），与 Stirling PDF 一起 compose。

### 版本管理
- [x] 初始化 Git 仓库，提交基线并创建 `v0.1.0` 标签。
- [ ] 设置远端仓库并推送：`git remote add origin <repo_url>`；`git push -u origin master --tags`。
  - [ ] 若远端有更新，使用 `git pull --rebase` 解决冲突再推送。
- [ ] 规范提交信息与分支策略（约定式提交、feature/bugfix/release 分支）。
  - [x] 创建可回退快照：`snapshot-eaea063`、`stable-eaea063`（对齐文本坐标阶段）。
  - [x] 创建可回退快照：`snapshot-6134fe5`、`stable-6134fe5`（清空重做与拖动并发渲染修复）。
  - [x] 创建可回退快照：`snapshot-5f18acd`、`stable-5f18acd`（文本选择与编辑选择拆分、编辑 UX 修复）。
  - [x] 创建可回退快照：`snapshot-e043e4b`、`stable-underline-fix`（下划线功能精确定位重构）。

## 最近完成的功能 (Recent Completions)

### 下划线功能重构 (2024)
- [x] **问题诊断**：原下划线功能存在精度问题，选中部分文本但下划线出现在错误位置
- [x] **根本原因**：基于文本跨度（span）检测的方法不够精确，PDF文本项可能包含多个词汇
- [x] **解决方案**：重构为基于 `Range.getClientRects()` 的精确坐标检测
  - [x] 使用浏览器原生选区API获取真实选择边界
  - [x] 实现完整坐标转换链：客户端坐标 → text-layer坐标 → viewport坐标 → PDF坐标
  - [x] 支持跨行选择和复杂选择形状
  - [x] 移除依赖文本跨度检测的旧逻辑
- [x] **功能验证**：测试确认可精确选择部分文本（如"Tracking"）并正确添加下划线
- [x] **性能优化**：考虑浏览器兼容性和内存管理，处理边界情况
- [x] **文档更新**：更新README.md和cursorlog.md说明下划线功能改进和使用方法
- [x] **版本发布**：提交哈希 `e043e4b`，标签 `stable-underline-fix`，已推送到远端仓库

### 页面重排导出功能 (2024)
- [x] **问题识别**：页面重排功能只影响前端视觉，导出仍按原始顺序
- [x] **客户端导出改进**：修改 `exportPdf` 函数按 `pageOrder` 重新排列页面和注释
- [x] **服务端导出改进**：前端发送 `pageOrder` 信息，服务端按序处理页面
- [x] **注释映射保持**：确保注释与原始页码关联，重排后正确显示在对应页面
- [x] **调试功能**：添加详细日志和测试按钮，便于验证页面映射关系
- [x] **文档更新**：更新README说明页面重排导出的使用方法和技术细节
- [x] **版本发布**：提交哈希 `16120d6`，功能完整可用
- [x] **问题修复**：修复服务端导出页面重排功能的FormData接收和验证逻辑问题
- [x] **调试改进**：增强前后端调试日志，便于问题诊断和功能验证
- [x] **功能验证**：客户端和服务端导出页面重排功能均已验证正常工作

## 验收标准（DoD）
- [ ] 核心查看功能稳定（加载、分页、缩放、旋转、搜索、缩略图）。
- [ ] 注释层可用（文本/高亮/形状），支持撤销/重做与跨页。
- [ ] 至少一种稳定导出路径（客户端或服务端）。
- [ ] Stirling PDF 常用能力在 UI 可用（合并/拆分/旋转/压缩/转换）。
- [ ] 关键步骤、思考、坑位均记录在 `cursorlog.md`。


