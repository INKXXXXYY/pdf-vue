# PDF Viewer/Annotator (Vue 3 + PDF.js)

功能概览
- PDF 预览、分页、缩放、旋转、缩略图与书签
- 搜索与页内高亮
- 注释：文本/高亮矩形/矩形/下划线，编辑选择拖动/删除（工具栏按钮），撤销/重做
- 图片注释：插入/删除/拖动/缩放/旋转；把手随缩放同步，底边把手仅调整底边（已修复）
- 注释持久化（localStorage）、JSON 导入/导出
- 客户端导出：将注释扁平化到新 PDF（pdf-lib）
- 服务端导出：Node/Express 接口扁平化注释并返回 PDF
 - 原文替换（Replace）：在“原文替换”模式下展示整页文本红色虚线框，双击某块即可替换；替换通过“遮罩+覆盖文本”实现并在导出时扁平化。
  - 支持中文等非 ASCII 文本：自动加载 CJK 字体（Noto/思源），或逐字渲染保障位置稳定

本地开发（局域网可访问）
```bash
npm install
npm run dev
```
默认端口 5173，Vite 已配置 `host: true`，同网段设备可通过你的电脑 IP 访问：
http://<你的局域网IP>:5173

生产预览（局域网可访问）
```bash
npm run build
npm run preview
```
默认端口 4173，同样可通过：
http://<你的局域网IP>:4173

可在 `.env` 中自定义端口：
```
VITE_PORT=5173
VITE_PREVIEW_PORT=4173
```

服务端导出（Node + Express）
```bash
# 启动后端（默认 3000）
npm run server

# （可选）.env 设置前端代理目标（缺省回落到 http://localhost:3000）
# VITE_API_BASE_URL=http://localhost:3000

# 前端开发（默认 5173）
npm run dev
```

接口说明
- POST `/api/annotate/flatten`
  - form-data 参数（二选一）
    - `file`: application/pdf 原始 PDF（上传）
    - `url`: 原始 PDF 的可访问 URL
  - 以及：
    - `annotations`: 前端注释 JSON（与运行时结构一致）
  - 返回：application/pdf（扁平化后的新 PDF）

注意
- 预览/生产环境不走 Vite 代理。请使用完整地址调用后端 `http://<后端IP>:3000/api/...` 或配置反向代理。
- 服务器默认放开 CORS（可通过环境变量 `ALLOW_ORIGIN` 自行限制）。
 - 重要：中文导出依赖字体文件。请自行下载 CJK 字体（如 Noto Sans SC 或 Source Han Sans SC）放到 `server/fonts/` 目录，或设置环境变量 `CJK_FONT_FILE` 指向字体路径；否则包含中文的文本将无法正确导出。
 - 若在 GitHub 网页端看不到最新 README，请确认切换到 `master` 分支并刷新页面。

近期更新
- 新增：文本选择与编辑选择工具拆分
  - 文本选择（Text Select）：原生选中文本，复制粘贴；选择时禁用自定义框选，overlay 空白穿透。
  - 编辑选择（Edit Select）：选择/多选/拖动/删除已有注释；禁止新建图形，避免误触。
- 新增：手工文本层（兼容构建环境无法直接使用 TextLayerBuilder）
  - 绝对定位的轻量 span，按 PDF 矩阵换算位置与宽度；外层 transform 缩放与画布 CSS 尺寸对齐。
  - 透明文字 + `#text-layer ::selection` 显示高亮，可视化选区。
- 修复/优化：
  - 图片注释把手同步、底边把手仅调整底边；
  - 文本编辑流程（避免双层文本；打开时隐藏原节点，提交/取消后恢复；只重绘注释层）；
  - 选择模式下禁用绘制，绘制仅在高亮/矩形/绘图工具生效。
  - 新增绘图（自由画笔）：SVG 预览、折线导出，颜色/粗细可调。
- 新增 Shapes：椭圆、直线、箭头（预览含箭头头部、渲染/导出含箭头）与多边形。
- 新增 橡皮擦：可调半径，拖动命中即删（矩形类用外接矩形，path/多边形用点到线段距离，文本用近似宽高）。
- 新增 下划线：精确的文本下划线标注
  - 基于真实文本选择（`Range.getClientRects()`）而非文本跨度推测
  - 支持精确的部分文本选择，即使在PDF文本项内选择单个词汇也能精确定位
  - 自动坐标转换：客户端坐标 → text-layer坐标 → viewport坐标 → PDF坐标
  - 支持跨行选择和复杂选择形状
 - 新增 页面重排：侧栏每个缩略图提供"上移/下移"按钮；视觉顺序与缩略图一致，翻页按新顺序；顺序持久化（localStorage）。
  - **导出页面重排**：客户端和服务端导出现在都完全支持按调整后的页面顺序生成PDF
  - 导出时会按 `pageOrder` 重新排列页面，同时正确映射注释到对应页面
  - 修复了服务端FormData接收和页面顺序验证逻辑，确保功能稳定可靠
  - 包含完整的调试日志显示页面映射关系，便于验证导出结果
 - 服务端导出（中文）
   - 内置字体加载顺序：环境变量 `CJK_FONT_FILE` > `server/fonts/` 常见文件名（含 `NotoSansSC-VariableFont_wght.ttf`）> 扫描目录挑选 `Noto/SourceHan`。
   - 已接入 `@pdf-lib/fontkit` 并注册，支持嵌入 TTF/OTF；对可变字体关闭 subset，避免子集化导致字符缺失。
   - 对非 ASCII 文本逐字绘制并按字体测宽推进，规避个别可变字体宽度错位。

下划线（Underline）使用说明
- 在工具下拉里选择"下划线"，页面会显示蓝色虚线框标注的可选文本块。
- 用鼠标选择要添加下划线的文本（支持精确的部分选择）：
  - 可以选择整个词汇、短语或句子
  - 即使在同一PDF文本项内也能精确选择单个词汇
  - 支持跨行选择和复杂选择形状
- 松开鼠标后，下划线会自动添加到选中文本的正下方
- 下划线位置完全基于实际选择边界，不受PDF文本项分组影响

编辑选择与删除功能使用说明
- **选择注释**：在工具下拉里选择"编辑选择"，点击任何注释进行选择
- **多选注释**：按住Shift键点击可同时选择多个注释
- **删除选中**：选中注释后，工具栏会出现"删除选中"按钮，点击即可删除
- **键盘快捷键**：也可使用Delete或Backspace键删除选中的注释
- **拖拽移动**：选中的注释可以直接拖拽移动位置
- **调整大小**：选中矩形类注释时会显示缩放把手，可调整尺寸

页面重排与导出说明
- **调整页面顺序**：在侧栏缩略图下方使用"上移/下移"按钮调整页面顺序
- **导出重排页面**：
  - 客户端导出：点击"导出PDF"，生成的PDF将按调整后的页面顺序排列
  - 服务端导出：点击"服务端导出"，服务端会按接收到的页面顺序重新排列
  - 注释会正确映射到对应的页面，不会因为页面重排而错位
- **测试功能**：点击"测试页面重排"按钮查看当前页面顺序和使用说明
- **持久化**：页面顺序会自动保存到localStorage，重新加载后保持

原文替换（Replace）使用说明
- 在工具下拉里选择"原文替换"，页面会显示红色虚线框标注的文本块。
- 双击某个虚线框进入编辑：
  - 覆盖一层白色遮罩（自动加厚，避免下行字符漏出）；
  - 在相同位置放置文本注释并打开内联编辑（回车提交、Esc 取消）。
- 也可先用"文本选择"选中，再用"替换选中文本"一次替换一块。
- 替换为"遮罩+覆盖文本"方式，不改动源 PDF 字节；导出（本地/服务端）会扁平化到新 PDF。

字体配置（服务端中文导出）
```
# 放置字体（任选一种）
# 1) 将字体放入 server/fonts/，例如：server/fonts/NotoSansSC-VariableFont_wght.ttf
# 2) 或设置环境变量指向字体
#   Windows PowerShell：
#   $env:CJK_FONT_FILE="server/fonts/NotoSansSC-VariableFont_wght.ttf"
#   （使用 setx 永久设置后需重启进程）

# 重启服务端
npm run server

# 导出时控制台应出现：
# [server] CJK font via ...
# [server] CJK font loaded for export
```

常见问题
- 字体版权：推荐使用 Noto Sans SC / Source Han Sans SC（OFL 许可，可商用与嵌入）。
- 若不希望依赖字体，可改为“中文文本栅格化为图片再嵌入”，请在 issue 中反馈。

版本快照
 - 稳定标签：`stable-5f18acd`、`stable-arrow-head`、`stable-eraser`、`stable-reorder`、`stable-underline-fix`、`stable-reorder-export-v2`、`stable-v1.1.0`
 - 快照分支：`snapshot-5f18acd`、`snapshot-arrow-head`、`snapshot-eraser`、`snapshot-reorder`、`snapshot-e043e4b`、`snapshot-9bc3544`

## 当前版本 v1.1.0 重要说明

### 已修复功能
- ✅ **原文替换功能优化**：修复了双击编辑时失去焦点的问题，编辑框尺寸现在与原红框一致
- ✅ **下划线功能修复**：解决了编辑其他元素后无法选中文本添加下划线的问题
- ✅ **图片导出修复**：修复了添加图片后导出PDF看不到图片的问题，现在图片可以正常导出
- ✅ **编辑后红框保持**：修复了编辑文本后其他红框消失的问题，现在会保持显示以提示可继续编辑

### 已知限制
⚠️ **文本span偏移问题**：
- 在使用原文替换、下划线、文本选择等功能时，可能出现span元素位置偏移的情况
- 这个问题与PDF文本层的复杂布局和坐标转换有关
- 目前暂时没有找到完美的解决方法

### 功能稳定性
- 所有核心功能（注释、导出、编辑等）均已测试稳定
- 图片添加和导出功能已完全修复
- 原文替换和下划线功能的用户体验得到显著改善
- 建议在生产环境中使用此版本

开源许可
- 本项目建议使用 MIT 许可证（LICENSE 文件）。
